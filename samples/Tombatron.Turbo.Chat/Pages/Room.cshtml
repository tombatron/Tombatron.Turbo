@page "{id}"

@model RoomModel
@{
    // TODO: Change how this is computed.
    ViewData["Title"] = $"#{Model.Room?.Name ?? "Chat"}";
}

<!-- Subscribe to room-specific stream -->
<turbo-stream-source-signalr stream="room:@Model.RoomId" hub-url="/turbo-hub" />
<turbo-stream-source-signalr stream="room-list:@Model.Username" hub-url="/turbo-hub"/>

<div class="app-container">
    <!-- Sidebar with rooms -->
    <div class="sidebar">
        <div class="sidebar-header">
            Turbo Chat
        </div>

        <div id="room-list" class="room-list">
            @foreach (var room in Model.Rooms)
            {
                <partial name="_RoomEntry" model="@(Model.RoomId, Model.Username, room)" />
            }
        </div>

        <div class="user-panel">
            <div class="user-avatar">@Model.Username[0].ToString().ToUpper()</div>
            <div class="user-name">@Model.Username</div>
            <div id="connection-dot" class="connection-dot disconnected"></div>
        </div>
    </div>

    <!-- Main chat area -->
    <div class="chat-area"
         data-controller="chat"
         data-chat-room-id-value="@Model.RoomId">
        <div class="chat-header">
            @if (Model.Room?.Members is { Count: 2 })
            {
                @functions{

                    string OtherUser => Model.Room?.Members?.First(m => !string.Equals(m.Username, Model!.Username, StringComparison.InvariantCultureIgnoreCase)).Username ?? string.Empty;
                }
                <h2>DM - @OtherUser</h2>
                <span class="chat-description">Private messages with @OtherUser</span>
            }
            else
            {
                <h2>@Model.Room?.Name</h2>
                <span class="chat-description">@Model.Room?.Description</span>
            }
        </div>

        <!-- Messages container -->
        <div id="messages-container" class="messages-container" data-chat-target="messagesContainer">
            <div id="messages" data-chat-target="messages">
                @if (!Model.Messages.Any())
                {
                    <div class="empty-messages">
                        No messages yet. Start the conversation!
                    </div>
                }
                else
                {
                    @foreach (var message in Model.Messages)
                    {
                        <partial name="_Message" model="message" />
                    }
                }
            </div>
        </div>

        <!-- Typing indicator - Stimulus controller filters out current user -->
        <div id="typing-indicator"
             class="typing-indicator"
             data-controller="typing-indicator"
             data-typing-indicator-current-user-value="@Model.Username"></div>

        <!-- Message input -->
        <div class="input-area">
            <form method="post"
                  asp-page-handler="SendMessage"
                  class="message-form"
                  data-action="turbo:submit-end->chat#submitted">
                <input type="hidden" name="roomId" value="@Model.RoomId" />
                <input type="text"
                       name="content"
                       class="message-input"
                       placeholder="Message #@Model.Room?.Name"
                       autocomplete="off"
                       required
                       data-chat-target="input"
                       data-action="input->chat#typing" />
                <button type="submit" class="send-btn">Send</button>
            </form>
        </div>
    </div>

    <!-- Right flyaway sidebar -->
    <div id="profile-sidebar" class="right-sidebar" data-controller="profile-sidebar" data-profile-sidebar-room-id-value="@Model.RoomId">
        <div class="sidebar-header">
            <span>Details</span>
            <button class="sidebar-close-btn" type="button" data-action="click->profile-sidebar#hide">&times;</button>
        </div>
        <div class="sidebar-content">
            <turbo-frame id="user-profile" data-profile-sidebar-target="frame">
            </turbo-frame>

            <div data-profile-sidebar-target="loading" class="profile-loading hidden">
                <div class="profile-loading-avatar"></div>
                <div class="profile-loading-line"></div>
                <div class="profile-loading-line short"></div>
                <div class="profile-loading-line"></div>
                <div class="profile-loading-line short"></div>
            </div>
        </div>
    </div>
</div>

