@page "{id:int}"
@model RoomModel
@{
    ViewData["Title"] = Model.Room?.IsDirectMessage == true
        ? Model.DirectMessageRooms.FirstOrDefault(dm => dm.Room.Id == Model.RoomId).OtherUsername ?? "DM"
        : $"#{Model.Room?.Name ?? "Chat"}";
}

<!-- Subscribe to room-specific stream -->
<turbo-stream-source-signalr stream="room:@Model.RoomId" hub-url="/turbo-hub" />
<!-- Subscribe to user-specific stream for unread badges and DM notifications -->
<turbo-stream-source-signalr stream="user:@Model.CurrentUserId" hub-url="/turbo-hub" />

<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            Turbo Chat
            <a href="/Logout" class="logout-btn">Exit</a>
        </div>

        <!-- Direct Messages -->
        <div class="sidebar-section">
            <div class="sidebar-section-header">Direct Messages</div>
            <div id="dm-room-list">
                @foreach (var dm in Model.DirectMessageRooms)
                {
                    <partial name="_DmEntry" model="@(Model.RoomId, dm.OtherUsername, dm.Room, Model.UnreadCounts.GetValueOrDefault(dm.Room.Id))" />
                }
            </div>
        </div>

        <!-- Public Rooms -->
        <div class="sidebar-section">
            <div class="sidebar-section-header">
                Rooms
                <button type="button" class="add-room-btn"
                        data-controller="create-room"
                        data-action="click->create-room#toggle">+</button>
            </div>
            <div id="create-room-form" class="create-room-form" style="display:none;">
                <form method="post" asp-page-handler="CreateRoom" data-turbo-frame="_top">
                    <input type="text" name="name" class="sidebar-input" placeholder="Room name" required maxlength="30" />
                    <input type="text" name="description" class="sidebar-input" placeholder="Description (optional)" maxlength="100" />
                    <button type="submit" class="sidebar-submit-btn">Create</button>
                </form>
            </div>
            <div id="public-room-list">
                @foreach (var room in Model.PublicRooms)
                {
                    <partial name="_RoomEntry" model="@(Model.RoomId, room, Model.UnreadCounts.GetValueOrDefault(room.Id))" />
                }
            </div>
        </div>

        <!-- Users -->
        <div class="sidebar-section">
            <div class="sidebar-section-header">Users</div>
            <div id="user-list">
                @foreach (var user in Model.AllUsers)
                {
                    @if (user.Id != Model.CurrentUserId)
                    {
                        <partial name="_UserEntry" model="user" />
                    }
                }
            </div>
        </div>

        <div class="user-panel">
            <div class="user-avatar">@Model.Username[0].ToString().ToUpper()</div>
            <div class="user-name">@Model.Username</div>
            <div id="connection-dot" class="connection-dot disconnected"></div>
        </div>
    </div>

    <!-- Main chat area -->
    <div class="chat-area"
         data-controller="chat"
         data-chat-room-id-value="@Model.RoomId">
        <div class="chat-header">
            @if (Model.Room?.IsDirectMessage == true)
            {
                var otherUsername = Model.DirectMessageRooms
                    .FirstOrDefault(dm => dm.Room.Id == Model.RoomId).OtherUsername ?? "Unknown";
                <h2 class="dm-header">@otherUsername</h2>
                <span class="chat-description">Private messages with @otherUsername</span>
            }
            else
            {
                <h2>@Model.Room?.Name</h2>
                <span class="chat-description">@Model.Room?.Description</span>
            }
        </div>

        <!-- Messages container -->
        <div id="messages-container" class="messages-container" data-chat-target="messagesContainer">
            <div id="messages" data-chat-target="messages">
                @if (!Model.Messages.Any())
                {
                    <div class="empty-messages" id="empty-messages-placeholder">
                        No messages yet. Start the conversation!
                    </div>
                }
                else
                {
                    @foreach (var message in Model.Messages)
                    {
                        <partial name="_Message" model="message" />
                    }
                }
            </div>
        </div>

        <!-- Typing indicator -->
        <div id="typing-indicator"
             class="typing-indicator"
             data-controller="typing-indicator"
             data-typing-indicator-current-user-value="@Model.Username"></div>

        <!-- Message input -->
        <div class="input-area">
            <form method="post"
                  asp-page-handler="SendMessage"
                  class="message-form"
                  data-action="turbo:submit-end->chat#submitted">
                <input type="hidden" name="roomId" value="@Model.RoomId" />
                <input type="text"
                       name="content"
                       class="message-input"
                       placeholder="Message #@(Model.Room?.IsDirectMessage == true ? ViewData["Title"] : Model.Room?.Name)"
                       autocomplete="off"
                       required
                       data-chat-target="input"
                       data-action="input->chat#typing" />
                <button type="submit" class="send-btn">Send</button>
            </form>
        </div>
    </div>

    <!-- Right flyaway sidebar -->
    <div id="profile-sidebar" class="right-sidebar" data-controller="profile-sidebar" data-profile-sidebar-room-id-value="@Model.RoomId">
        <div class="sidebar-header">
            <span>Details</span>
            <button class="sidebar-close-btn" type="button" data-action="click->profile-sidebar#hide">&times;</button>
        </div>
        <div class="sidebar-content">
            <turbo-frame id="user-profile" data-profile-sidebar-target="frame">
            </turbo-frame>

            <div data-profile-sidebar-target="loading" class="profile-loading hidden">
                <div class="profile-loading-avatar"></div>
                <div class="profile-loading-line"></div>
                <div class="profile-loading-line short"></div>
                <div class="profile-loading-line"></div>
                <div class="profile-loading-line short"></div>
            </div>
        </div>
    </div>
</div>
